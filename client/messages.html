<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
        integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/css/fonts.css">
    <link rel="stylesheet" href="/css/messages.css">
    <link rel="stylesheet" href="/css/navigation.css">
    <title>Messages</title>
</head>

<body>
    <div class="overlay" id="overlay"></div>
    <div id="sidebarContainer"></div>
    <div id="navbarContainer"></div>

    <div class="main-content">
        <div class="main-container">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('chat', this)">
                    <i class="fas fa-comments"></i> Live Chat
                    <span class="badge" id="chatBadge" style="display: none;">2</span>
                </button>
                <button class="nav-tab" onclick="switchTab('announcements', this)">
                    <i class="fas fa-bullhorn"></i> Announcements
                    <span class="badge" id="announcementsBadge">3</span>
                </button>
            </div>

            <!-- Live Chat Tab -->
            <div class="tab-content active" id="chatTab">
                <div class="chat-container">
                    <div class="chat-sidebar" id="chatSidebar">
                        <div class="chat-header">
                            <h2>Conversations</h2>
                            <div class="chat-search">
                                <span class="search-icon"><i class="fas fa-search"></i></span>
                                <input type="text" placeholder="Search contacts..." id="chatSearchInput">
                            </div>
                            <button class="create-announcement-btn" style="margin-top:0.75rem" onclick="openNewMessageModal()">
                                <i class="fas fa-plus"></i> New Message
                            </button>
                        </div>
                        <div class="chat-contacts" id="chatContacts">
                            <!-- Contacts will be populated here -->
                        </div>
                    </div>
                    <!-- Mobile overlay for chat sidebar -->
                    <div class="chat-sidebar-overlay" id="chatSidebarOverlay"></div>

                    <div class="chat-main" id="chatMain">
                        <div class="empty-chat">
                            <i class="fas fa-comments"></i>
                            <h3>Select a conversation</h3>
                            <p>Choose from your existing conversations or start a new one</p>
                            <button type="button" class="create-announcement-btn" style="margin-top:0.75rem; display:none;" onclick="openChatSidebarMobile()" id="openConversationsMobileBtn">
                                <i class="fas fa-bars" id="open-convo-burger"></i> Open conversations
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Announcements Tab -->
            <div class="tab-content" id="announcementsTab">
                <div class="announcements-header">
                    <div class="announcements-title">
                        <i class="fas fa-bullhorn"></i>
                        <h2>Property Announcements</h2>
                    </div>
                    <button class="create-announcement-btn" onclick="openCreateAnnouncementModal()">
                        <i class="fas fa-plus-circle"></i>
                        Create Announcement
                    </button>
                </div>

                <div class="announcements-filters">
                    <div class="filter-group">
                        <button class="filter-chip active" onclick="setAnnouncementFilter('all', this)">
                            <i class="fas fa-list"></i> All Announcements
                        </button>
                        <button class="filter-chip" onclick="setAnnouncementFilter('important', this)">
                            <i class="fas fa-star"></i> Important
                        </button>
                        <button class="filter-chip" onclick="setAnnouncementFilter('maintenance', this)">
                            <i class="fas fa-tools"></i> Maintenance
                        </button>
                        <button class="filter-chip" onclick="setAnnouncementFilter('events', this)">
                            <i class="fas fa-calendar-alt"></i> Events
                        </button>
                    </div>

                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search announcements..." id="announcementSearch">
                    </div>
                </div>

                <div class="announcements-list-container">
                    <div class="announcements-grid" id="announcementsList">
                        <!-- Announcements will be populated here -->
                    </div>
                    
                    <!-- Pagination will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Announcement Modal -->
    <div class="modal-overlay" id="createAnnouncementModal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h3><i class="fas fa-bullhorn"></i> Create New Announcement</h3>
                <button class="modal-close" onclick="closeModal('createAnnouncementModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label for="announcementTitle">Announcement Title</label>
                    <input type="text" id="announcementTitle" placeholder="Enter announcement title..." required>
                </div>
                <div class="modal-field">
                    <label for="announcementCategory">Category</label>
                    <select id="announcementCategory">
                        <option value="general">General</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="events">Events</option>
                        <option value="policy">Policy Update</option>
                        <option value="emergency">Emergency</option>
                    </select>
                </div>
                <div class="modal-field">
                    <label for="announcementPriority">Priority Level</label>
                    <div class="priority-selector">
                        <label class="priority-option">
                            <input type="radio" name="priority" value="low">
                            <span class="priority-badge low"><i class="fas fa-circle"></i> Low</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="medium" checked>
                            <span class="priority-badge medium"><i class="fas fa-circle"></i> Medium</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="high">
                            <span class="priority-badge high"><i class="fas fa-circle"></i> High</span>
                        </label>
                    </div>
                </div>
                <div class="modal-field">
                    <label for="announcementContent">Announcement Content</label>
                    <textarea id="announcementContent" placeholder="Type your announcement here..." required rows="8"></textarea>
                </div>
                <div class="modal-field">
                    <label>
                        <input type="checkbox" id="pinAnnouncement">
                        Pin this announcement to the top
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('createAnnouncementModal')">Cancel</button>
                <button class="modal-btn primary" onclick="createAnnouncement()">
                    <i class="fas fa-bullhorn"></i> Publish Announcement
                </button>
            </div>
        </div>
    </div>

    <!-- View Announcement Modal -->
    <div class="modal-overlay" id="viewAnnouncementModal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <div class="announcement-modal-title" id="modalAnnouncementTitle"></div>
                <button class="modal-close" onclick="closeModal('viewAnnouncementModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="announcement-modal-meta" id="modalAnnouncementMeta"></div>
                <div class="announcement-modal-content" id="modalAnnouncementContent"></div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('viewAnnouncementModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Message</h3>
                <button class="modal-close" onclick="closeModal('deleteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this message? This action cannot be undone.</p>
                <div style="margin-top: 16px; padding: 12px; background: #f8f9fb; border-radius: 8px;">
                    <strong id="deleteSubject"></strong>
                    <div style="color: #64748b; font-size: 14px; margin-top: 4px;" id="deleteSender"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('deleteModal')">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDeleteMessage()">Delete Message</button>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div class="modal-overlay" id="newMessageModal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h3><i class="fas fa-paper-plane"></i> New Message</h3>
                <button class="modal-close" onclick="closeModal('newMessageModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-field">
                    <label for="recipientSearch">Recipient</label>
                    <div class="chat-search">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="text" placeholder="Search tenants..." id="recipientSearch" oninput="searchRecipients(this.value)">
                    </div>
                    <div id="recipientResults" style="max-height: 300px; overflow: auto; margin-top: 0.5rem;"></div>
                </div>
                <div class="modal-field">
                    <label for="newMessageText">Message</label>
                    <textarea id="newMessageText" rows="3" placeholder="Type your message..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('newMessageModal')">Cancel</button>
                <button class="modal-btn primary" onclick="sendFirstMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="module" src="/javascript/messages.js"></script>
    <script>
        var user = null;
        try {
            user = JSON.parse(localStorage.getItem('user'));
        } catch (e) { }

        var userRole = (user && user.role) ? user.role.toUpperCase() : 'TENANT';

        if (userRole === 'ADMIN') {
            var script = document.createElement('script');
            script.src = '/javascript/navigationsAdmin.js';
            document.body.appendChild(script);
        } else {
            var script = document.createElement('script');
            script.src = '/javascript/navigationsTenant.js';
            document.body.appendChild(script);
        }
    </script>
</body>

</html>